<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DRAWRY-Drawing</title>
    <style>
/* ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
#container {
  width: 90vw;
  max-width: 1920px;
  height: 90vh;
  max-height: 1080px;
  display: flex;
  flex-direction: column; /* ì„¸ë¡œ ì •ë ¬ */
  align-items: center;
  justify-content: center;
  position: relative;
  background: #fffff6;
}

/* ì•ˆë‚´ ë¬¸êµ¬ (ìº”ë²„ìŠ¤ ìœ„) */
#guideText {
  text-align: center;
  color: #979797;
  font-size: 2vw;
  font-family: Inter, sans-serif;
  font-weight: 800;
  margin-bottom: 20px; /* ìº”ë²„ìŠ¤ì™€ ê°„ê²© */
}

#selectedInfo{
  text-align: center;
  color: #979797;
  font-size: 2vw;
  font-family: Inter, sans-serif;
  font-weight: 800;
  margin-bottom: 20px; /* ìº”ë²„ìŠ¤ì™€ ê°„ê²© */
  display: none;
}

/* ìº”ë²„ìŠ¤ */
.drawingsection {
  width: 85%;
  max-width: 1729px;
  height: auto;
  aspect-ratio: 2 / 1;
  border: 5px solid #ff8e03;
  border-radius: 16px;
  background: white;
  touch-action: none;
}

/* ë„êµ¬ ì˜ì—­ (íˆ´ë°•ìŠ¤) - ìº”ë²„ìŠ¤ í•˜ë‹¨ ì¤‘ì•™ */
.toolbox {
  width: 80%;
  max-width: 600px;
  height: 100px;
  background: white;
  border: 7px solid #ff8e03;
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: space-around;
  margin-top: 20px; /* ìº”ë²„ìŠ¤ ì•„ë˜ ë°°ì¹˜ */
}

.toolbox input[type="range"] {
  width: 100px;
}
.toolbox input[type="color"] {
  width: 55px;
  height: 55px;
  padding: 0;
  border: none;
  background: none;
}
.toolbox button {
  width: 52px;
  height: 55px;
  border: none;
  background-size: cover;
  cursor: pointer;
}
/* ê° ë²„íŠ¼ ë³„ ë°°ê²½ ì´ë¯¸ì§€*/
#startDrawingBtn {
  background: url('src/pencil_.png') no-repeat center;
}
#clearBtn {
  background: url('src/Eraser_.png') no-repeat center;
}
#stopDrawingBtn {
  width: 55px;
  height: 55px;
  background: url('src/pointer.png') no-repeat center;
}

/* ì €ì¥ ë²„íŠ¼ */
#saveBtn {
  border: none;
  width: 200px;
  height: 60px;
  background: #ff8e03;
  border-radius: 40px;
  cursor: pointer;
  font-size: 20px;
  color: white;
  font-weight: bold;
  position: absolute;
  right: 10%; /* ì™¼ìª½ìœ¼ë¡œ ì´ë™ */
  top: 58px;
}   
</style>
  </head>
  <body>
      <div id="container">
        <!-- ë’¤ë¡œê°€ê¸° ë²„íŠ¼ -->
        <button id="backBtn"
          style="
            width: 55px;
            height: 55px;
            left: 90px;
            top: 80px;
            position: absolute;
            border: none;
            cursor: pointer;
            background-color: #fffff6;
          "
        >â†</button>

        <!-- ì•ˆë‚´ ë¬¸êµ¬ -->
        <div id="guideText">
          ì£¼ ì¸ ê³µ ì˜ ì „ ì‹  ëª¨ ìŠµ ì„ ê·¸ ë ¤ ì¤˜<br />
          ì•„ ë˜ ì¥ ë©´ ì˜ ê·¸ ë¦¼ ì„ ìƒ ì„± í•´ ë³´ ì:D
        </div>

        <div id="selectedInfo"></div>
    
        <!-- ìº”ë²„ìŠ¤ -->
        <canvas id="drawingCanvas" class="drawingsection"></canvas>
    
        <!-- ë„êµ¬ ì˜ì—­ (ìº”ë²„ìŠ¤ í•˜ë‹¨ ì¤‘ì•™) -->
        <div class="toolbox">
          <input type="range" id="penSize" min="1" max="50" value="5" />
          <button id="startDrawingBtn"></button>
          <button id="clearBtn"></button>
          <input type="color" id="colorPicker" value="#000000" />
          <button id="stopDrawingBtn"></button>
        </div>
    
        <!-- ì €ì¥ ë²„íŠ¼ (ì™¼ìª½ìœ¼ë¡œ ì¡°ì •) -->
        <button id="saveBtn">ê·¸ë¦¼ ë§Œë“¤ê¸°</button>
      </div>

    <script>
      // ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
      const canvas = document.getElementById("drawingCanvas");
      const ctx = canvas.getContext("2d");
      const startDrawingBtn = document.getElementById("startDrawingBtn");
      const stopDrawingBtn = document.getElementById("stopDrawingBtn");
      const clearBtn = document.getElementById("clearBtn");
      const saveBtn = document.getElementById("saveBtn");
      const colorPicker = document.getElementById("colorPicker");
      const penSize = document.getElementById("penSize");
      let drawing = false;
      let isDrawingActive = false; // ê·¸ë¦¬ê¸° ëª¨ë“œ í™œì„±í™” ì—¬ë¶€

      // âœ… ì´ì „ ì„ íƒ ì •ë³´ ë¶ˆëŸ¬ì™€ í‘œì‹œ
      const time = localStorage.getItem("time") || "ì•Œ ìˆ˜ ì—†ëŠ” ì‹œê°„";
        const place = localStorage.getItem("place") || "ì•Œ ìˆ˜ ì—†ëŠ” ì¥ì†Œ";
        const action = localStorage.getItem("action") || "ì•Œ ìˆ˜ ì—†ëŠ” í–‰ë™";

        const prompt = `A character in a fantasy world, during ${time}, at ${place}, ${action}`;
        document.getElementById("selectedInfo").innerText = `ì£¼ì¸ê³µì´ ${time}ì— ${place}ì—ì„œ ${action}`;

        function getEventPos(e) {
            if (e.touches && e.touches[0]) {
                const rect = canvas.getBoundingClientRect();
                return { offsetX: e.touches[0].clientX - rect.left, offsetY: e.touches[0].clientY - rect.top };
            } else {
                return { offsetX: e.offsetX, offsetY: e.offsetY };
            }
        }
        
        // ê·¸ë¦¬ê¸° ì‹œì‘ ë²„íŠ¼ ì´ë²¤íŠ¸
        startDrawingBtn.addEventListener("click", () => {
    isDrawingActive = true;
    startDrawingBtn.disabled = true;
    stopDrawingBtn.disabled = false;
    canvas.style.borderColor = "#FF4F03"; // í™œì„±í™” í‘œì‹œ

    // ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì •
    canvas.width = window.innerWidth * 0.85;  // 85% í¬ê¸°
    canvas.height = canvas.width * (2 / 1);  // ë¹„ìœ¨ ë§ì¶”ê¸° (2:1)

    // ì‹¤ì œ ìº”ë²„ìŠ¤ í¬ê¸° ê³„ì‚°
    canvas.style.width = `${canvas.width}px`;
    canvas.style.height = `${canvas.height}px`;

    // ì•ˆë‚´ ë¬¸êµ¬ ìˆ¨ê¸°ê³ , ì„ íƒ ì •ë³´ í‘œì‹œ
    document.getElementById("guideText").style.display = "none";
    const selectedInfo = document.getElementById("selectedInfo");
    selectedInfo.innerText = `ì£¼ì¸ê³µì´ ${time}ì— ${place}ì—ì„œ ${action}`;
    selectedInfo.style.display = "block";
});
     // ë§ˆìš°ìŠ¤/í„°ì¹˜ ì¢Œí‘œ ì¶”ì¶œ (í„°ì¹˜ ì´ë²¤íŠ¸ ì§€ì›)
function getEventPos(e) {
  const rect = canvas.getBoundingClientRect();
  let offsetX, offsetY;

  // í„°ì¹˜ ì´ë²¤íŠ¸ì¸ ê²½ìš°
  if (e.touches && e.touches[0]) {
    offsetX = e.touches[0].clientX - rect.left;
    offsetY = e.touches[0].clientY - rect.top;
  } else {  // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ì¸ ê²½ìš°
    offsetX = e.offsetX;
    offsetY = e.offsetY;
  }

  // ë¹„ìœ¨ì„ ê³ ë ¤í•˜ì—¬ ì¢Œí‘œë¥¼ ë°˜í™˜
  return {
    offsetX: offsetX * (canvas.width / rect.width),
    offsetY: offsetY * (canvas.height / rect.height)
  };
}

// ê·¸ë¦¬ê¸° ì‹œì‘
function startDrawing(e) {
  if (!isDrawingActive) return;
  drawing = true;
  // UIì—ì„œ ì„¤ì •í•œ ìƒ‰ìƒ, êµµê¸° ì ìš©
  ctx.strokeStyle = colorPicker.value;
  ctx.lineWidth = penSize.value;
  ctx.lineCap = "round";
  // ì‹œì‘ ì¢Œí‘œ ì„¤ì •
  const pos = getEventPos(e);
  ctx.beginPath();
  ctx.moveTo(pos.offsetX, pos.offsetY);
  e.preventDefault();
}

// ê·¸ë¦¬ê¸° ì§„í–‰
function draw(e) {
  if (!drawing || !isDrawingActive) return;
  const pos = getEventPos(e);
  ctx.lineTo(pos.offsetX, pos.offsetY);
  ctx.stroke();
  e.preventDefault();
}

// ê·¸ë¦¬ê¸° ì¢…ë£Œ
function stopDrawing(e) {
  if (!isDrawingActive) return;
  drawing = false;
  ctx.closePath();
  if (e) e.preventDefault();
}

// ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
canvas.addEventListener("mousedown", startDrawing);
canvas.addEventListener("mousemove", draw);
canvas.addEventListener("mouseup", stopDrawing);
canvas.addEventListener("mouseleave", stopDrawing);

// í„°ì¹˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ëª¨ë°”ì¼ ì§€ì›)
canvas.addEventListener("touchstart", startDrawing);
canvas.addEventListener("touchmove", draw);
canvas.addEventListener("touchend", stopDrawing);
canvas.addEventListener("touchcancel", stopDrawing);

// ê·¸ë¦¬ê¸° ì¤‘ì§€ ë²„íŠ¼ ì´ë²¤íŠ¸
stopDrawingBtn.addEventListener("click", () => {
  isDrawingActive = false;
  drawing = false;
  startDrawingBtn.disabled = false;
  stopDrawingBtn.disabled = true;
  canvas.style.borderColor = "#ff8e03"; // ë¹„í™œì„±í™” í‘œì‹œ
});

// ìº”ë²„ìŠ¤ ì§€ìš°ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
clearBtn.addEventListener("click", () => {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
});

// ê·¸ë¦¼ ì €ì¥ ë²„íŠ¼ ì´ë²¤íŠ¸
      saveBtn.addEventListener("click", () => {
            const imageData = canvas.toDataURL("image/png");

            console.log("ğŸ“¤ Sending request to Flask...");
            console.log("Prompt:", prompt);

            localStorage.setItem("imageProcessing", "true");

            fetch(`${CONFIG.FLASK_SERVER}/api/generate`, {
                method: "POST",
                body: JSON.stringify({ image: imageData, prompt: prompt }),
                headers: { "Content-Type": "application/json" }
            })
            .then(response => response.json())
            .then(data => {
                if (data.staus === "processing") {
                } else {
                    alert("ì´ë¯¸ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                }
            })
            .catch(error => {
                alert("Flask ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });

            window.location.href = "9_makeimage.html";
        });
    </script>
  </body>
</html>
