<!DOCTYPE html>
<html lang="kor" dir="Itr">
    <head>
        <meta charset="utf-8">
        <title>DRAWRY-Make Img</title>
        <style>
            /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
body {
    background: #fffff6;
    font-family: "Inter", sans-serif;
    margin:0;
    padding:0;
    display:flex;
    justify-content: center;
    align-items: center;
    height: 100vh;

}

/*ê³µí†µ ë ˆì´ì•„ì›ƒ*/
.container{
    text-align: center;
    width: 1024px;
}

.title{
    font-size: 25px;
    font-weight: 800;
    margin-bottom: 20px;
}

.subtitle{
    font-size: 20px;
    color:#979797;
    margin-bottom: 40px;

}

/*ë²„íŠ¼ ìŠ¤íƒ€ì¼*/
.btn-container{ 
    display:flex;
    justify-content: center;
    gap: 20px;
    flex-wrap:wrap;
}

.btn { 
    border: none;
    background:#FF8E03;
    color: #fffff6;
    font-size: 20px;
    font-weight: 800;
    border-radius: 22px; 
    padding: 10px 20px;
    cursor: pointer;
    transition: background 0.3s;
    position:relative;
    top: 150px;    
}

.btn:hover {
    background: #E07702;

}

/*ë’¤ë¡œê°€ê¸° ë²„íŠ¼*/ 

.back-btn{
    background:none;
    border:none;
    font-size: 20px;
    cursor: pointer;
    position: absolute;
    top: 20px;
    left:20px;
}

.select-container{ 
    display:flex;
    justify-content: center;
    gap: 20px;
    flex-wrap:wrap;
}

.select-box {
        width: 391px;
        height: 340px;
        background: #FFFFF6;
        border-radius: 11px;
        border: 2px solid #FF8E03;
    }

        </style>
    </head>
    <body>

        <section id="loading">
            <div class="container">
                <div class="title">ì… ë ¥ í•œ  ì • ë³´ ë¡œ<br>
                    ë¡œ ë¦¬ ê°€  ê·¸ ë¦¼ ì„  ë§Œ ë“œ ëŠ” ì¤‘ ì´ ì•¼  !<br>
                    ì¡° ê¸ˆ ë§Œ  ê¸° ë‹¤ ë ¤ ì¤˜  !</div>
                <button id="backBtn" class="back-btn">â†</button>

            </div>
        </section>

        <section id="makeimg">
            <div class="title">ê·¸ ë¦¼ ì´  ì™„ ì„± ë ì–´ !<br>
                ê°™ ì´  ë³´ ëŸ¬ ê°ˆ ë˜ ?</div>
            <button class="btn" id="yes">ì‘ !</button>
            <button id="backBtn" class="back-btn">â†</button>
        </section>

        <section id="showimg">
            <div class="title">ì§œ ì” !  ë§ˆ ìŒ ì—  ë“œ ëŠ” ê·¸ ë¦¼ ì„ ê³¨ ë¼ ì¤˜ ! </div>
            <div class="select-container">
                <div class="select-box" id="sel1"></div>
                <div class="select-box" id="sel2"></div>
                <div class="select-box" id="sel3"></div>
            </div>
            <div class="btn-container">
            <button class="btn" id="retry">ë‹¤ì‹œë§Œë“¤ì–´ì¤˜!</button>
            <button class="btn" id="remake">ë‹¤ì‹œê·¸ë¦´ë˜!</button>
            </div>
            <button id="backBtn" class="back-btn">â†</button>

        </section>
        <script type="module">
            import CONFIG from './config.js';
    
            document.addEventListener("DOMContentLoaded", () => {
                const FLASK_SERVER = CONFIG.FLASK_SERVER;
    
                const loadingSection = document.getElementById("loading");
                const makeimgSection = document.getElementById("makeimg");
                const showimgSection = document.getElementById("showimg");
    
                const yesBtn = document.getElementById("yes");
                const retryBtn = document.getElementById("retry");
                const remakeBtn = document.getElementById("remake");
                const backBtns = document.querySelectorAll(".back-btn");
    
                const sel1 = document.getElementById("sel1");
                const sel2 = document.getElementById("sel2");
                const sel3 = document.getElementById("sel3");
    
                // ì´ˆê¸° ì„¹ì…˜ ì„¤ì •
                loadingSection.style.display = "block";
                makeimgSection.style.display = "none";
                showimgSection.style.display = "none";
    
                // ì´ë¯¸ì§€ ìƒì„± ìƒíƒœ í™•ì¸
                function checkImageStatus() {
                    fetch(`${FLASK_SERVER}/api/status`)
                        .then(response => response.json())
                        .then(data => {
                            if (!data.processing && data.image_urls.length === 3) {
                                console.log("âœ… ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ!");
                                localStorage.setItem("generatedImages", JSON.stringify(data.image_urls));
    
                                [sel1, sel2, sel3].forEach((el, idx) => {
                                    el.innerHTML = `<img src="${FLASK_SERVER}${data.image_urls[idx]}" />`;
                                });
    
                                loadingSection.style.display = "none";
                                makeimgSection.style.display = "block";
                            } else {
                                console.log("â³ ì´ë¯¸ì§€ ìƒì„± ì¤‘...");
                                setTimeout(checkImageStatus, 3000);
                            }
                        })
                        .catch(error => console.error("ğŸš¨ ìƒíƒœ í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error));
                }
    
                // "ì‘!" ë²„íŠ¼ í´ë¦­ ì‹œ showimg ì„¹ì…˜ í‘œì‹œ
                yesBtn.addEventListener("click", () => {
                    makeimgSection.style.display = "none";
                    showimgSection.style.display = "block";
                });
    
                // ë‹¤ì‹œ ë§Œë“¤ê¸° (Drawing.htmlë¡œ ì´ë™)
                retryBtn.addEventListener("click", () => {
                    localStorage.removeItem("generatedImages");
                    localStorage.setItem("imageProcessing", "true");
                    window.location.href = "8_Drawing.html";
                });
    
                // ë‹¤ì‹œ ê·¸ë¦¬ê¸° (getcharacter.htmlë¡œ ì´ë™)
                remakeBtn.addEventListener("click", () => {
                    localStorage.removeItem("generatedImages");
                    localStorage.setItem("imageProcessing", "true");
                    window.location.href = "getcharacter.html";
                });
    
                // ì´ë¯¸ì§€ ì„ íƒ ì‹œ ë‹¤ìŒ í˜ì´ì§€ë¡œ ì´ë™ (ì„ íƒí•œ ì´ë¯¸ì§€ ì €ì¥)
                function selectImage(imageIdx) {
                    const images = JSON.parse(localStorage.getItem("generatedImages"));
                    if (images && images[imageIdx]) {
                        localStorage.setItem("selectedImage", images[imageIdx]);
                        window.location.href = "10_makestory.html"
                    }
                }
    
                sel1.addEventListener("click", () => selectImage(0));
                sel2.addEventListener("click", () => selectImage(1));
                sel3.addEventListener("click", () => selectImage(2));
    
                // ë’¤ë¡œê°€ê¸° ë²„íŠ¼ ì„¤ì •
                backBtns.forEach(btn => {
                    btn.addEventListener("click", () => {
                        if (makeimgSection.style.display === "block") {
                            makeimgSection.style.display = "none";
                            loadingSection.style.display = "block";
                        } else if (showimgSection.style.display === "block") {
                            showimgSection.style.display = "none";
                            makeimgSection.style.display = "block";
                        }
                    });
                });
    
                // ì´ë¯¸ì§€ ìƒì„± ëŒ€ê¸° ì¤‘ì´ë©´ ìƒíƒœ í™•ì¸ ì‹œì‘
                if (localStorage.getItem("imageProcessing") === "true") {
                    checkImageStatus();
                }
            });
        </script>
    </body>
</html>
